#cloud-config
package_update: true
package_upgrade: true

# Create proxy files reliably using write_files (these will be templated by Terraform)
write_files:
  - path: /opt/minecraft-proxy/nginx.conf
    content: |
      events {
          worker_connections 1024;
      }
      
      stream {
          upstream minecraft_backend {
              server ${minecraft_backend_ip}:25565;
          }
          
          server {
              listen 25565;
              proxy_pass minecraft_backend;
              proxy_timeout 1s;
              proxy_responses 1;
              proxy_connect_timeout 1s;
          }
          
          error_log /var/log/nginx/error.log;
      }

  - path: /opt/minecraft-proxy/docker-compose.yml
    content: |
      version: '3.8'
      
      services:
        minecraft-proxy:
          image: nginx:1.25-alpine
          container_name: minecraft-reverse-proxy
          ports:
            - "25565:25565"
          volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
          restart: unless-stopped
          environment:
            - NGINX_ENTRYPOINT_QUIET_LOGS=1

  - path: /opt/minecraft-proxy/update-backend-ip.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      NEW_IP="$1"
      
      if [ -z "$NEW_IP" ]; then
          echo "Usage: $0 <new-backend-ip>"
          exit 1
      fi
      
      if ! [[ $NEW_IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
          echo "Error: Invalid IP address format"
          exit 1
      fi
      
      echo "Updating backend IP to: $NEW_IP:25565"
      sed -i "s/server [0-9]\{1,3\}\\.[0-9]\{1,3\}\\.[0-9]\{1,3\}\\.[0-9]\{1,3\}:25565;/server $NEW_IP:25565;/" /opt/minecraft-proxy/nginx.conf
      
      cd /opt/minecraft-proxy
      # prefer docker compose plugin
      if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
        docker compose restart minecraft-proxy
      elif [ -x "/usr/local/bin/docker-compose" ]; then
        /usr/local/bin/docker-compose restart minecraft-proxy
      else
        echo "No docker compose available"
        exit 1
      fi
      
      echo "âœ… Backend IP updated to $NEW_IP:25565"

  - path: /opt/minecraft-proxy/README.md
    content: |
      # Minecraft Reverse Proxy
      
      This Oracle Cloud instance runs a reverse proxy for Minecraft traffic.
      
      ## Management Commands
      
      Check status:
      ```bash
      cd /opt/minecraft-proxy
      docker compose ps
      docker compose logs
      ```
      
      Update backend IP:
      ```bash
      sudo /opt/minecraft-proxy/update-backend-ip.sh NEW_IP_HERE
      ```
      
      Manual restart:
      ```bash
      cd /opt/minecraft-proxy
      sudo docker compose restart
      ```

  - path: /etc/systemd/system/minecraft-proxy.service
    content: |
      [Unit]
      Description=Minecraft Reverse Proxy
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/minecraft-proxy
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target

final_message: "Minecraft reverse proxy setup complete!"

# runcmd: install Docker reliably, start the stack and enable the service
runcmd:
  - |
    set -euxo pipefail
    echo "==> Installing prerequisites and Docker Engine (official repo)"
    apt-get update
    apt-get install -y ca-certificates curl gnupg lsb-release apt-transport-https software-properties-common

    # Use the distro-provided docker package to avoid repository/GPG issues during cloud-init
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y docker.io containerd docker-compose-plugin || true

    # Install legacy docker-compose binary as fallback
    if [ ! -x /usr/local/bin/docker-compose ]; then
      COMPOSE_VER="v2.20.2"
      curl -fsSL "https://github.com/docker/compose/releases/download/${COMPOSE_VER}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose || true
    fi

    # Ensure docker starts
    systemctl daemon-reload || true
    systemctl enable docker || true
    systemctl start docker || true

    # Ensure /opt/minecraft-proxy exists and files from write_files are present
    mkdir -p /opt/minecraft-proxy
    chown ubuntu:ubuntu /opt/minecraft-proxy || true

    # Start the proxy using docker compose (plugin) with fallback
    if docker compose version >/dev/null 2>&1; then
      (cd /opt/minecraft-proxy && docker compose pull || true && docker compose up -d)
    elif [ -x /usr/local/bin/docker-compose ]; then
      (cd /opt/minecraft-proxy && /usr/local/bin/docker-compose pull || true && /usr/local/bin/docker-compose up -d)
    else
      echo "No docker compose available, aborting start"
    fi

    # Enable systemd unit
    systemctl daemon-reload || true
    systemctl enable minecraft-proxy.service || true
    systemctl start minecraft-proxy.service || true
