#cloud-config
package_update: true
package_upgrade: true

# Install packages and configure services
runcmd:
  # Install packages with retries
  - |
    echo "Installing required packages..."
    for pkg in docker.io docker-compose nginx curl wget htop net-tools; do
      for i in {1..3}; do
        if sudo DEBIAN_FRONTEND=noninteractive apt-get install -y $pkg; then
          echo "✅ Installed $pkg"
          break
        else
          echo "Failed to install $pkg, attempt $i/3"
          sleep 5
        fi
      done
    done
  # Wait for apt to finish and verify packages
  - |
    echo "Waiting for apt/dpkg to be available..."
    while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1 || sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do
      echo "Waiting for other package manager to finish..."
      sleep 1
    done
  
  # Install Docker if not present (backup method)
  - |
    if ! command -v docker &> /dev/null; then
      echo "Docker not found, installing via convenience script..."
      curl -fsSL https://get.docker.com -o get-docker.sh
      sudo sh get-docker.sh
    fi
  
  # Configure Docker
  - systemctl enable docker || true
  - systemctl start docker || true
  - usermod -aG docker ubuntu
  
  # Verify Docker is running
  - |
    echo "Verifying Docker installation..."
    for i in {1..30}; do
      if systemctl is-active docker >/dev/null 2>&1; then
        echo "✅ Docker is running"
        break
      fi
      echo "Waiting for Docker to start... ($i/30)"
      sleep 2
    done
  
  # Create directory and set permissions
  - mkdir -p /opt/minecraft-proxy
  - chmod 755 /opt/minecraft-proxy/update-backend-ip.sh
  
  # Verify files exist before starting
  - |
    echo "Verifying required files..."
    for file in nginx.conf docker-compose.yml update-backend-ip.sh; do
      if [ ! -f "/opt/minecraft-proxy/$file" ]; then
        echo "❌ Error: /opt/minecraft-proxy/$file not found"
        exit 1
      fi
    done
    echo "✅ All required files present"
  
  # Start the proxy with verification
  - |
    cd /opt/minecraft-proxy
    docker-compose pull
    docker-compose up -d
    
    # Verify container is running
    for i in {1..5}; do
      if docker-compose ps | grep -q "Up"; then
        echo "✅ Minecraft proxy container is running"
        break
      fi
      echo "Waiting for container to start... ($i/5)"
      sleep 5
    done
  
  # Create systemd service for auto-start
  - |
    cat > /etc/systemd/system/minecraft-proxy.service << EOF
    [Unit]
    Description=Minecraft Reverse Proxy
    Requires=docker.service
    After=docker.service
    
    [Service]
    Type=oneshot
    RemainAfterExit=yes
    WorkingDirectory=/opt/minecraft-proxy
    ExecStart=/usr/bin/docker-compose up -d
    ExecStop=/usr/bin/docker-compose down
    TimeoutStartSec=0
    
    [Install]
    WantedBy=multi-user.target
    EOF
  
  - systemctl enable minecraft-proxy.service
  - systemctl start minecraft-proxy.service

write_files:
  - path: /opt/minecraft-proxy/README.md
    content: |
      # Minecraft Reverse Proxy
      
      This Oracle Cloud instance runs a reverse proxy for Minecraft traffic.
      
      ## Management Commands
      
      Check status:
      ```bash
      cd /opt/minecraft-proxy
      docker-compose ps
      docker-compose logs
      ```
      
      Update backend IP:
      ```bash
      sudo /opt/minecraft-proxy/update-backend-ip.sh NEW_IP_HERE
      ```
      
      Manual restart:
      ```bash
      cd /opt/minecraft-proxy
      sudo docker-compose restart
      ```
      
      ## Files
      - `/opt/minecraft-proxy/nginx.conf` - Nginx configuration
      - `/opt/minecraft-proxy/docker-compose.yml` - Docker Compose setup
      - `/opt/minecraft-proxy/update-backend-ip.sh` - IP update script

  - path: /opt/minecraft-proxy/nginx.conf
    content: |
      events {
          worker_connections 1024;
      }
      
      stream {
          upstream minecraft_backend {
              server ${minecraft_backend_ip}:25565;
          }
          
          server {
              listen 25565;
              proxy_pass minecraft_backend;
              proxy_timeout 1s;
              proxy_responses 1;
              proxy_connect_timeout 1s;
          }
          
          error_log /var/log/nginx/error.log;
      }

  - path: /opt/minecraft-proxy/docker-compose.yml
    content: |
      version: '3.8'
      
      services:
        minecraft-proxy:
          image: nginx:1.25-alpine
          container_name: minecraft-reverse-proxy
          ports:
            - "25565:25565"
          volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
          restart: unless-stopped
          environment:
            - NGINX_ENTRYPOINT_QUIET_LOGS=1

  - path: /opt/minecraft-proxy/update-backend-ip.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      NEW_IP="$1"
      
      if [ -z "$NEW_IP" ]; then
          echo "Usage: $0 <new-backend-ip>"
          exit 1
      fi
      
      if ! [[ $NEW_IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
          echo "Error: Invalid IP address format"
          exit 1
      fi
      
      echo "Updating backend IP to: $NEW_IP:25565"
      sed -i "s/server [0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}:25565;/server $NEW_IP:25565;/" /opt/minecraft-proxy/nginx.conf
      
      cd /opt/minecraft-proxy
      docker-compose restart minecraft-proxy
      
      echo "✅ Backend IP updated to $NEW_IP:25565"

final_message: "Minecraft reverse proxy setup complete!"